import styled from "@emotion/styled";
import { useEffect, useState } from "react";
import { MilliePageReal } from "./MilliePageReal";

// Í∞úÎ∞úÏö© Ïª®Ìä∏Î°§ Ìå®ÎÑê
const DevPanel = styled.div`
  position: fixed;
  top: 10px;
  left: 10px;
  padding: 15px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  z-index: 10000;
  max-width: 300px;
`;

const DevTitle = styled.h3`
  color: #333;
  font-size: 14px;
  margin-bottom: 10px;
  font-weight: 600;
`;

const DevButtonGroup = styled.div`
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 10px;
`;

const DevButton = styled.button<{
  variant?: "primary" | "secondary" | "danger";
}>`
  padding: 6px 12px;
  font-size: 12px;
  font-weight: 500;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;

  ${(props) => {
    switch (props.variant) {
      case "danger":
        return `
          background: #e53e3e;
          color: white;
          &:hover {
            background: #c53030;
          }
        `;
      default:
        return `
          background: #667eea;
          color: white;
          &:hover {
            background: #5a67d8;
          }
        `;
    }
  }}
`;

const StatusText = styled.div`
  color: #666;
  font-size: 11px;
  margin-top: 8px;
  padding: 8px;
  background: #f7fafc;
  border-radius: 4px;

  span {
    font-weight: 600;
    color: #333;
  }
`;
// const PresetSection = styled.div`
//   margin-top: 12px;
//   padding-top: 12px;
//   border-top: 1px solid #e2e8f0;
// `;

// const PresetTitle = styled.h4`
//   color: #333;
//   font-size: 12px;
//   margin-bottom: 8px;
//   font-weight: 600;
// `;

// const PresetButton = styled.button<{ isActive?: boolean }>`
//   padding: 8px 12px;
//   font-size: 11px;
//   font-weight: 500;
//   border: 1px solid ${(props) => (props.isActive ? "#667eea" : "#cbd5e0")};
//   border-radius: 4px;
//   cursor: pointer;
//   transition: all 0.2s ease;
//   background: ${(props) => (props.isActive ? "#667eea" : "white")};
//   color: ${(props) => (props.isActive ? "white" : "#4a5568")};
//   width: 100%;
//   margin-bottom: 6px;
//   text-align: left;

//   &:hover {
//     background: ${(props) => (props.isActive ? "#5a67d8" : "#f7fafc")};
//     border-color: #667eea;
//   }

//   .preset-id {
//     font-weight: 700;
//     margin-right: 6px;
//   }

//   .preset-name {
//     font-size: 10px;
//   }
// `;

// const CurrentPreset = styled.div`
//   padding: 6px 8px;
//   background: #edf2f7;
//   border-radius: 4px;
//   margin-bottom: 8px;
//   font-size: 11px;
//   color: #2d3748;

//   strong {
//     color: #667eea;
//   }
// `;
// const SpeedSection = styled.div`
//   margin-top: 12px;
//   padding-top: 12px;
//   border-top: 1px solid #e2e8f0;
// `;

// const SpeedTitle = styled.h4`
//   color: #333;
//   font-size: 12px;
//   margin-bottom: 8px;
//   font-weight: 600;
// `;

// const SpeedButton = styled.button<{ isActive?: boolean }>`
//   padding: 8px 12px;
//   font-size: 11px;
//   font-weight: 500;
//   border: 1px solid ${(props) => (props.isActive ? "#667eea" : "#cbd5e0")};
//   border-radius: 4px;
//   cursor: pointer;
//   transition: all 0.2s ease;
//   background: ${(props) => (props.isActive ? "#667eea" : "white")};
//   color: ${(props) => (props.isActive ? "white" : "#4a5568")};
//   width: 100%;
//   margin-bottom: 6px;
//   text-align: left;

//   &:hover {
//     background: ${(props) => (props.isActive ? "#5a67d8" : "#f7fafc")};
//     border-color: #667eea;
//   }

//   .speed-value {
//     font-weight: 700;
//     margin-right: 6px;
//   }

//   .speed-name {
//     font-size: 10px;
//   }
// `;

// const CurrentSpeed = styled.div`
//   padding: 6px 8px;
//   background: #edf2f7;
//   border-radius: 4px;
//   margin-bottom: 8px;
//   font-size: 11px;
//   color: #2d3748;

//   strong {
//     color: #667eea;
//   }
// `;

// eslint-disable-next-line react-refresh/only-export-components
export default function App() {
  const [widget, setWidget] = useState<MillieChatPlugin | null>(null);
  const [isVisible, setIsVisible] = useState(false);
  const [clickCount, setClickCount] = useState(0);
  const [currentCharacter, setCurrentCharacter] = useState<string | null>(null);
  // const [currentPresetId, setCurrentPresetId] = useState<number>(60);
  // const [currentAnimationSpeed, setCurrentAnimationSpeed] =
  //   useState<number>(500);

  // const presetOptions = [
  //   { id: 61, name: "[Ï±ÑÌåÖ Î™®Îç∏] Î∞ÄÎ¶¨ Ï∫êÎ¶≠ÌÑ∞ - GPT4o" },
  //   { id: 60, name: "[Ï±ÑÌåÖ Î™®Îç∏] Î∞ÄÎ¶¨ Ï∫êÎ¶≠ÌÑ∞ - Ï†úÎØ∏ÎÇòÏù¥" },
  //   { id: 59, name: "[Ï±ÑÌåÖ Î™®Îç∏] Î∞ÄÎ¶¨ Ï∫êÎ¶≠ÌÑ∞ - ÌÅ¥Î°úÎìú" },
  // ];
  // const speedOptions = [
  //   { value: 0, name: "Ï¶âÏãú (Ïï†ÎãàÎ©îÏù¥ÏÖò ÏóÜÏùå)" },
  //   { value: 100, name: "Îß§Ïö∞ Îπ†Î¶Ñ" },
  //   { value: 200, name: "Îß§Ïö∞ Îπ†Î¶Ñ2" },
  //   { value: 300, name: "Îπ†Î¶Ñ" },
  //   { value: 400, name: "Îπ†Î¶Ñ2" },
  //   { value: 500, name: "Î≥¥ÌÜµ (Í∏∞Î≥∏)" },
  //   { value: 600, name: "Î≥¥ÌÜµ (Í∏∞Î≥∏)2" },
  //   { value: 700, name: "Î≥¥ÌÜµ (Í∏∞Î≥∏)3" },
  //   { value: 800, name: "ÎäêÎ¶º" },
  //   { value: 1000, name: "ÎäêÎ¶º2" },
  //   { value: 1200, name: "Îß§Ïö∞ ÎäêÎ¶º" },
  // ];

  useEffect(() => {
    // SDK Ï¥àÍ∏∞Ìôî ÏòàÏ†ú
    // 1. MillieChatPlugin Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
    console.log("HI");
    const plugin = new window.MillieChatSDK.MillieChatPlugin({
      // Î™®Î∞îÏùºÏóêÏÑú Ï†ÑÏ≤¥ÌôîÎ©¥ Ïó¨Î∂Ä
      mobileFullscreen: true,
      // messageAnimationSpeed: currentAnimationSpeed,
      onChatRoomCreated: async (a, b) => {
        console.log(a, b, "Ï±óÎ£∏ÏÉùÏÑ± Ìï®Ïàò...");
      },
      onClickSendButton: async (a, b) => {
        console.log(a, b, "Î≥¥ÎÇ¥Í∏∞Ïù¥Î≤§Ìä∏...");
      },
      // ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
      onClickProfileImage: async (a, b) => {
        console.log(a, b, "Profile image clicked! Moving to detail page...");
        alert(
          "ÌîÑÎ°úÌïÑÏùÑ ÌÅ¥Î¶≠ÌñàÏäµÎãàÎã§! Ïó¨Í∏∞Ïóê ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ Ïù¥Îèô Î°úÏßÅÏùÑ Íµ¨ÌòÑÌïòÏÑ∏Ïöî."
        );
      },
    });

    // React stateÏóê Ï†ÄÏû•
    setWidget(plugin);

    console.log("‚úÖ Millie Chat SDK Ï¥àÍ∏∞Ìôî ÏôÑÎ£å");

    // Ïª¥Ìè¨ÎÑåÌä∏ Ïñ∏ÎßàÏö¥Ìä∏ Ïãú Ï†ïÎ¶¨
    return () => {
      plugin.destroy();
      console.log("üßπ Widget Ï†ïÎ¶¨ ÏôÑÎ£å");
    };
  }, []);
  // const changePreset = (presetId: number) => {
  //   setCurrentPresetId(presetId);
  //   if (widget) {
  //     widget.setPresetId(presetId);
  //     console.log(`‚úÖ Preset changed to: ${presetId}`);
  //   }
  // };

  const showLocalStorageKey = () => {
    const myKey = localStorage?.getItem("millie-session-key");
    if (!myKey) {
      return alert("ÌÇ§Î•º Î®ºÏ†Ä Î∞úÍ∏âÎ∞õÏïÑÏ£ºÏÑ∏Ïöî");
    } else if (!currentCharacter) {
      return alert("Ïù¥Ï†Ñ Ï±ÑÌåÖÏù¥ ÏóÜÏäµÎãàÎã§.");
    } else {
      widget?.show({ sessionId: myKey, character: currentCharacter }); // Îã§Î•∏ Ï∫êÎ¶≠ÌÑ∞Î°ú ÌÖåÏä§Ìä∏
      setIsVisible(true);
      setClickCount((prev) => prev + 1);
    }
  };

  const showWidget = () => {
    // ÏÉà ÏÑ∏ÏÖò ID ÏÉùÏÑ± ÎòêÎäî Í∏∞Ï°¥ ÏÑ∏ÏÖò ÏÇ¨Ïö©
    const oldKey = "c5b144f8-c54f-450c-9545-57745489cf15";
    const sessionId = oldKey;

    // show Î©îÏÑúÎìúÏóê sessionIdÏôÄ characterName Ï†ÑÎã¨
    widget?.show({ sessionId, character: "Ï∞®ÏÑ†Í≤∏" });
    setIsVisible(true);
    setClickCount((prev) => prev + 1);
    console.log(
      "Widget shown with session:",
      sessionId,
      "character:",
      currentCharacter
    );
  };

  const showNewChat = (name: string) => {
    // ÏÉàÎ°úÏö¥ ÏÑ∏ÏÖò ID ÏÉùÏÑ±ÌïòÏó¨ ÏÉà Ï±ÑÌåÖÎ∞© Ïó¥Í∏∞
    const newSessionId = MillieChatSDK.MillieChatPlugin.newSessionId();
    localStorage?.setItem("millie-session-key", newSessionId);
    localStorage?.setItem("prev-chat-caracter", name);
    setCurrentCharacter(name);
    widget?.show({ sessionId: newSessionId, character: name }); // Îã§Î•∏ Ï∫êÎ¶≠ÌÑ∞Î°ú ÌÖåÏä§Ìä∏
    setIsVisible(true);
    setClickCount((prev) => prev + 1);
    console.log("New chat opened with session:", newSessionId);
  };

  const hideWidget = () => {
    widget?.hide();
    setIsVisible(false);
    setClickCount((prev) => prev + 1);
    console.log("Widget hidden");
  };

  const destroyWidget = () => {
    if (widget) {
      widget.destroy();
      setWidget(null);
      setIsVisible(false);
      console.log("Widget destroyed");

      // 2Ï¥à ÌõÑ Ïû¨ÏÉùÏÑ±
      setTimeout(() => {
        const newPlugin = new MillieChatPlugin({
          position: "bottom-right",
          mobileFullscreen: true,
          characterImages: ["ü§¥", "üëë", "üíú", "üåπ"],
          onChatRoomCreated: async (a, b) => {
            console.log(a, b, "Ï±óÎ£∏ÏÉùÏÑ±...");
          },
          // messageAnimationSpeed: currentAnimationSpeed,
          onClickSendButton: async (a, b) => {
            console.log(a, b, "Î≥¥ÎÇ¥Í∏∞Ïù¥Î≤§Ìä∏...");
          },

          messageLimit: 100,
          onClickProfileImage: async (a, b) => {
            console.log(
              a,
              b,
              "Profile image clicked! Moving to detail page..."
            );
            alert("ÌîÑÎ°úÌïÑÏùÑ ÌÅ¥Î¶≠ÌñàÏäµÎãàÎã§!");
          },
        });
        setWidget(newPlugin);
        console.log("‚úÖ Widget Ïû¨ÏÉùÏÑ± ÏôÑÎ£å");
      }, 2000);
    }
  };

  // const toggleCharacter = () => {
  //   if (currentCharacter === "Ï∞®ÏÑ†Í≤∏") {
  //     setCurrentCharacter("ÏÑúÎ¶¨");
  //   } else {
  //     setCurrentCharacter("Ï∞®ÏÑ†Í≤∏");
  //   }
  // };
  // const changeAnimationSpeed = (speed: number) => {
  //   setCurrentAnimationSpeed(speed);
  //   if (widget) {
  //     widget.setAnimationSpeed(speed);
  //     console.log(`‚úÖ Animation speed changed to: ${speed}ms`);
  //   }
  // };

  useEffect(() => {
    const name = localStorage?.getItem("prev-chat-caracter");
    if (name) {
      setCurrentCharacter(name);
    }
  }, []);

  return (
    <>
      {/* Millie ÌéòÏù¥ÏßÄ Î†åÎçîÎßÅ - Ïã§Ï†ú HTML ÏÇ¨Ïö© */}
      <MilliePageReal onStartChat={showWidget} />

      {/* Í∞úÎ∞úÏö© Ïª®Ìä∏Î°§ Ìå®ÎÑê */}
      <DevPanel>
        <DevTitle>üõ† SDK ÌÖåÏä§Ìä∏ Ïª®Ìä∏Î°§</DevTitle>

        <DevButtonGroup>
          <DevButton onClick={showWidget}>
            ÌïòÎìúÏΩîÎî©ÌÇ§Î°ú ÎåÄÌôîÌïòÍ∏∞(ÎÇ®Ïù¥ÎûëÍ≥µÏú†Ï§ë, Ï∞®ÏÑ†Í≤∏)
          </DevButton>
          <DevButton onClick={() => showNewChat("Ï∞®ÏÑ†Í≤∏")}>
            ÏÉàÎ°ú Ï∞®ÏÑ†Í≤∏Í≥º ÎåÄÌôîÌïòÍ∏∞
          </DevButton>
          <DevButton onClick={() => showNewChat("ÏÑúÎ¶¨")}>
            ÏÉàÎ°ú ÏÑúÎ¶¨ÏôÄ ÎåÄÌôîÌïòÍ∏∞
          </DevButton>
          {currentCharacter && (
            <DevButton onClick={showLocalStorageKey}>
              Í∏∞Ï°¥ ÎÇ¥ ÌÇ§Î°ú {currentCharacter}ÏôÄ ÎåÄÌôîÌïòÍ∏∞
            </DevButton>
          )}
          <DevButton onClick={hideWidget}>Hide</DevButton>
          {/* <DevButton onClick={toggleCharacter}>
            Toggle Character {currentCharacter}
          </DevButton> */}
          <DevButton variant="danger" onClick={destroyWidget}>
            Destroy
          </DevButton>

          {/* <PresetSection>
            <PresetTitle>ü§ñ Preset ÏÑ†ÌÉù</PresetTitle>
            <CurrentPreset>
              ÌòÑÏû¨ Preset: <strong>ID {currentPresetId}</strong>
            </CurrentPreset>
            {presetOptions.map((preset) => (
              <PresetButton
                key={preset.id}
                isActive={currentPresetId === preset.id}
                onClick={() => changePreset(preset.id)}
              >
                <span className="preset-id">{preset.id}</span>
                <span className="preset-name">{preset.name}</span>
              </PresetButton>
            ))}
          </PresetSection> */}
        </DevButtonGroup>
        {/* <SpeedSection>
          <SpeedTitle>‚ö° Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÜçÎèÑ</SpeedTitle>
          <CurrentSpeed>
            ÌòÑÏû¨ ÏÜçÎèÑ: <strong>{currentAnimationSpeed}ms</strong>
          </CurrentSpeed>
          {speedOptions.map((speed) => (
            <SpeedButton
              key={speed.value}
              isActive={currentAnimationSpeed === speed.value}
              onClick={() => changeAnimationSpeed(speed.value)}
            >
              <span className="speed-value">{speed.value}ms</span>
              <span className="speed-name">{speed.name}</span>
            </SpeedButton>
          ))}
        </SpeedSection> */}
        <StatusText>
          Ï¥àÍ∏∞Ìôî: <span>{widget ? "‚úÖ" : "‚ùå"}</span> | ÌëúÏãú:{" "}
          <span>{isVisible ? "‚úÖ" : "‚ùå"}</span> | ÌÅ¥Î¶≠:{" "}
          <span>{clickCount}</span>
        </StatusText>
      </DevPanel>
    </>
  );
}
